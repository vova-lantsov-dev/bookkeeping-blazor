@layout __Layout
@page "/children"
@inherits SessionController

<MyButton Color="blue" Text="Добавить ребёнка" Click=@(async () => NavigateTo("/child")) />

<LoadingAction CheckIfNullObject="@_models" IsOk="@IsOk" Message="Произошла ошибка при поиске детей."
               SubmitButtonText="Повторить" SubmitButtonAction="@UpdateListAsync">
    <AvatarListAction Models="@_models" Message="Детей пока что нет." />
</LoadingAction>

@functions
{
    private readonly List<AvatarItemModel> _models = new List<AvatarItemModel>();

    protected override async Task OnInitAsync()
    {
        await CheckAccessToken();

        // TODO refactoring
        var children = await GetAsync<List<ChildModel>>("/api/children");

        IsOk = children != default;
        if (!IsOk)
        {
            return;
        }

        _models.Clear();
        // ReSharper disable once PossibleNullReferenceException
        foreach (var child in children)
        {
            _models.Add(new AvatarItemModel
            {
                AvatarUrl = child.ImageUrl,
                Title = $"{child.LastName} {child.FirstName}".Trim(),
                ViewUrl = $"/child/{child.Id}"
            });
        }
    }

    private async Task UpdateListAsync()
    {
        IsOk = true;
        StateHasChanged();
        await OnInitAsync();
    }
}
