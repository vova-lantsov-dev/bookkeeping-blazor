@layout __Layout
@page "/"
@inherits BaseComponent

@using System.Globalization
@using BookkeepingNasheDetstvo.Client.Components.InputComponents;
@using BookkeepingNasheDetstvo.Client.Components.SubjectComponents;
@using BookkeepingNasheDetstvo.Client.Components.PopUpComponents;

<InputDateComponent Date="@Date" DateChanged="@(dt => Date = dt)" />

<ul class="w3-ul w3-card-4">
    @foreach (var date in Enumerable.Range(0, 7).Select(it => Date.AddDays(it)))
    {
        var name = DateTimeFormat.GetDayName(date.DayOfWeek);
        var value = date.ToString("dd/MM/yyyy", CultureInfo);
        var dateInfo = (value, name);
        <SubjectsTable DateInfo="@dateInfo" AllTeachers="@AllTeachers" PopUp="@PopUp" />
    }
</ul>

<SubjectPopUp ref="PopUp" EditSubjects="@(Current.EditSubjects || Current.IsOwner)" AllChildren="@AllChildren" />

@functions {
    private readonly static CultureInfo CultureInfo = new CultureInfo("ru-RU");
    private readonly static DateTimeFormatInfo DateTimeFormat = CultureInfo.DateTimeFormat;

    private DateTime Date { get; set; } = DateTime.Today;
    private List<SubjectItemModel> AllChildren { get; set; }
    private List<IdFullNamePair> AllTeachers { get; set; }
    private SubjectPopUp PopUp { get; set; }

    protected override async Task OnInitAsync()
    {
        await CheckAccessToken();
        await LoadCurrent();

        AllChildren = await Get<List<SubjectItemModel>>("/api/subject/allChildren");
        AllTeachers = await Get<List<IdFullNamePair>>("/api/subject/allTeachers");
    }
}